import random
import sqlite3
conn = sqlite3.connect('card.s3db')
cur = conn.cursor()

cur.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='card'")
table_exists = cur.fetchone()

if table_exists:
    cur.execute("PRAGMA table_info(card)")
    cols = [(row[1], row[2]) for row in cur.fetchall()]  # (name, type)
    if ("number", "TEXT") not in cols:
        cur.execute("DROP TABLE card")
        conn.commit()

cur.execute("""
CREATE TABLE IF NOT EXISTS card (
    id INTEGER,
    number TEXT,
    pin TEXT,
    balance INTEGER DEFAULT 0
)
""")
conn.commit()


def credit_card_maker():

    def account_management():

        def card_creation():
            def luhn_algorithm(number_15):
                digits = [int(x) for x in number_15 + "0"]
                for i in range(0, len(digits), 2):
                    digits[i] *= 2
                    if digits[i] > 9:
                        digits[i] -= 9
                return (10 - (sum(digits) % 10)) % 10

            def number_creation():
                while True:
                    bank_identifier = "400000"
                    current_customer = "".join(str(random.randrange(10)) for _ in range(9))
                    card_test_number = bank_identifier + current_customer

                    cur.execute("SELECT 1 FROM card WHERE number LIKE ?", (card_test_number + "%",))
                    if cur.fetchone() is None:
                        return card_test_number

            def pin_creation():
                return "".join(str(random.randrange(10)) for _ in range(4))

            card = number_creation()
            checksum = luhn_algorithm(card)
            final_card_number = card + str(checksum)
            pin = pin_creation()

            cur.execute(
                "INSERT INTO card (number, pin, balance) VALUES (?, ?, ?)",
                (final_card_number, pin, 0)
            )
            conn.commit()
            print(f"""Your card has been created
Your card number:
{final_card_number}
Your card PIN:
{pin}"""
)

        def account_login():
            menu = {
                "1": "1. Balance",
                "2": "2. Log out",
                "0": "0. Exit"
            }

            login_input = input("Enter your card number: ")
            pin_input = input("Enter your PIN: ")

            cur.execute(
                "SELECT balance FROM card WHERE number=? AND pin=?",
                (login_input, pin_input)
            )
            result = cur.fetchone()

            if result:
                print("You have successfully logged in!")
                balance = result[0]

                while True:
                    for option in menu.values():
                        print(option)

                    loged_choice = input()

                    if loged_choice == "1":
                        print(f"Balance: {balance}")
                    elif loged_choice == "2":
                        return
                    elif loged_choice == "0":
                        print("Bye!")
                        return "exit"
            else:
                print("Wrong card number or PIN!")

        def menu():
            while True:
                menu = {
                    "1": "1. Create an account",
                    "2": "2. Log into account",
                    "0": "0. Exit"
                }

                for option in menu.values():
                    print(option)

                user_choice = input()

                if user_choice == "1":
                    card_creation()
                elif user_choice == "2":
                    result = account_login()
                    if result == "exit":
                        return
                elif user_choice == "0":
                    print("Bye!")
                    return

        menu()

    account_management()


credit_card_maker()


